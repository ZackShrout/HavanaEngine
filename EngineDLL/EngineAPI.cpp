//******************************************
//Havana Engine API for use in Havana Editor
//******************************************
#ifndef WIN32_LEAN_AND_MEAN
#define WIN32_LEAN_AND_MEAN
#endif // !WIN32_LEAN_AND_MEAN

#include <Windows.h>
#include "Common.h"
#include "..\Engine\Components\Script.h"

using namespace Havana;

namespace
{
	HMODULE gameCodeDll{ nullptr };
	using get_script_creator = Havana::Script::Detail::script_creator(*)(size_t);
	get_script_creator GetScriptCreatorDll{ nullptr };
	using get_script_names = LPSAFEARRAY(*)(void);
	get_script_names GetScriptNamesDll{ nullptr };
} // anonymous namespace

/// <summary>
/// Load the .dll file generated by the scripts into the Havana Editor
/// for use.
/// </summary>
/// <param name="dllPath">Path of the .dll file.</param>
/// <returns>1 if successful, 0 if not.</returns>
EDITOR_INTERFACE u32 LoadGameCodeDll(const char* dllPath)
{
	if (gameCodeDll) return FALSE; // make sure it's not already loaded

	gameCodeDll = LoadLibraryA(dllPath);
	assert(gameCodeDll);

	GetScriptCreatorDll = (get_script_creator)GetProcAddress(gameCodeDll, "GetScriptCreatorDll");
	GetScriptNamesDll = (get_script_names)GetProcAddress(gameCodeDll, "GetScriptNamesDll");

	return (gameCodeDll && GetScriptCreatorDll && GetScriptNamesDll) ? TRUE : FALSE;
}

/// <summary>
/// Unload the .dll file generated by the scripts from the Havana Editor
/// </summary>
/// <param name="dllPath">Path of the .dll file.</param>
/// <returns>1 if successful, 0 if not.</returns>
EDITOR_INTERFACE u32 UnloadGameCodeDll()
{
	if (!gameCodeDll) return FALSE; // make sure it's already loaded
	assert(gameCodeDll);
	
	int result{ FreeLibrary(gameCodeDll) };
	assert(result);
	gameCodeDll = nullptr;
	
	return TRUE;
}

/// <summary>
/// Get a script creator function pointer for use in the Havana Editor
/// </summary>
/// <param name="name">Name of the script to get.</param>
/// <returns>Function pointer to script.</returns>
EDITOR_INTERFACE Script::Detail::script_creator GetScriptCreator(const char* name)
{
	return (gameCodeDll && GetScriptCreatorDll) ? GetScriptCreatorDll(Script::Detail::string_hash()(name)) : nullptr;
}

/// <summary>
/// Get the array of script names for use in the Havana Editor
/// </summary>
/// <returns>Array of script names.</returns>
EDITOR_INTERFACE LPSAFEARRAY GetScriptNames()
{
	return (gameCodeDll && GetScriptNamesDll) ? GetScriptNamesDll() : nullptr;
}